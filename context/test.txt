pipeline {
    agent {
        kubernetes {
            yaml '''
apiVersion: v1
kind: Pod
spec:
  containers:
  - name: aws
    image: caas-docker-release-local.docker.fis.dev/mirror/buildah/stable:v1.23.1
    command: ["cat"]
    tty: true
    volumeMounts:
      - name: workspace-volume
        mountPath: /home/jenkins/agent
        readOnly: false
    resources:
      requests:
        memory: "512Mi"
        cpu: "200m"
  volumes:
    - emptyDir: {}
      name: workspace-volume
'''
        }
    }

    parameters {
        string(name: 'CHART_NAME', description: 'Name of the Helm chart (e.g., nginx)')
        string(name: 'CHART_VERSION', description: 'Version to sync (e.g., 4.9.0)')
        string(name: 'TARGET_BRANCH', defaultValue: 'develop', description: 'Target branch in overlay repo')
    }

    environment {
        UPSTREAM_REPO = 'git@bitbucket.org:hydra/hydra-helm-upstreams.git'
        OVERLAY_REPO = 'git@bitbucket.org:hydra/hydra-helm-overlays.git'
    }

    stages {

        stage('Pre-checks') {
            steps {
                script {
                    if (!params.CHART_NAME || !params.CHART_VERSION) {
                        error("CHART_NAME and CHART_VERSION are mandatory")
                    }
                }
            }
        }

        stage('Clone Repos') {
            steps {
                container('aws') {
                    withCredentials([usernamePassword(credentialsId: 'kiran-creds', passwordVariable: 'BB_PASS', usernameVariable: 'BB_USER')]) {
                        sh '''
                        git clone https://${BB_USER}:${BB_PASS}@bitbucket.org/hydra/hydra-helm-upstreams.git --branch main
                        git clone https://${BB_USER}:${BB_PASS}@bitbucket.org/hydra/hydra-helm-overlays.git --branch ${TARGET_BRANCH}
                        '''
                    }
                }
            }
        }

        stage('Sync Chart to Overlays Repo') {
            steps {
                container('aws') {
                    sh '''
                    mkdir -p hydra-helm-overlays/${CHART_NAME}/chart
                    rsync -av --delete hydra-helm-upstreams/${CHART_NAME}/${CHART_VERSION}/ hydra-helm-overlays/${CHART_NAME}/chart/
                    '''
                }
            }
        }

        stage('Commit & Push to Overlay Repo') {
            steps {
                container('aws') {
                    withCredentials([usernamePassword(credentialsId: 'kiran-creds', passwordVariable: 'BB_PASS', usernameVariable: 'BB_USER')]) {
                        sh '''
                        cd hydra-helm-overlays
                        git config user.name "ci-bot"
                        git config user.email "ci-bot@hydra.org"
                        git add ${CHART_NAME}/chart
                        git commit -m "Synced ${CHART_NAME} version ${CHART_VERSION} from upstream"
                        git push origin ${TARGET_BRANCH}
                        '''
                    }
                }
            }
        }
    }

    post {
        always {
            cleanWs()
        }
    }
}



----------
Purpose: A readonly repo where Jenkins mirrors public Helm charts (e.g., ingress-nginx, cert-manager, keycloak).
Status: âœ… Created and integrated.
hydra-helm-overlays (Bitbucket repo)
Purpose: Customization repo where overlays (custom values.yaml, templates) live, based on upstream charts.
