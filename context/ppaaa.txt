@Library(['common-lib@3-stable']) _

properties([
    parameters([
        string(name: 'SRC_REPO_URL', defaultValue: 'https://charts.bitnami.com/bitnami', description: 'Public Helm repository URL'),
        string(name: 'SRC_REPO_NAME', defaultValue: 'bitnami', description: 'Public Helm repository name'),
        string(name: 'SRC_CHART_NAME', defaultValue: 'nginx', description: 'Source Helm chart name'),
        string(name: 'SRC_CHART_VERSION', defaultValue: '', description: 'Source Helm chart version (leave empty for latest)'),
        string(name: 'TARGET_BITBUCKET_REPO', defaultValue: 'hydra-helm-upstreams', description: 'Internal Bitbucket repo to push mirrored chart into')
    ])
])

String podTemplate = '''
apiVersion: v1
kind: Pod
spec:
  containers:
  - name: aws
    image: qas-docker-release-local.docker.fis.dev/jenkins/able-minion:helm-aws:3.6.3-1
    command: ["cat"]
    tty: true
'''.stripIndent()

podTemplate(yaml: podTemplate, label: 'hydra-pod') {
    node('hydra-pod') {

stage('Mirror Helm Chart from Public Repo') {
    container('aws') {
        sh '''
        if [[ "${SRC_REPO_URL}" == oci* ]]; then
            echo "Detected OCI Helm registry source"
            
            if [ -z "${SRC_CHART_VERSION}" ]; then
              echo "Error: OCI charts require version parameter."
              exit 1
            fi

            # OCI pull (no DockerHub login required for public Bitnami OCI charts)
            helm pull ${SRC_REPO_URL}/${SRC_CHART_NAME} --version ${SRC_CHART_VERSION}

            # Export the chart from OCI artifact format into traditional Helm chart directory
            helm chart export ${SRC_CHART_NAME}-${SRC_CHART_VERSION}.tgz -d ${SRC_CHART_NAME}

        else
            echo "Detected classic Helm repo"
            helm repo add ${SRC_REPO_NAME} ${SRC_REPO_URL}
            
            if [ -z "${SRC_CHART_VERSION}" ]; then
              helm pull ${SRC_REPO_NAME}/${SRC_CHART_NAME} --untar --untardir ${SRC_CHART_NAME}
            else
              helm pull ${SRC_REPO_NAME}/${SRC_CHART_NAME} --version ${SRC_CHART_VERSION} --untar --untardir ${SRC_CHART_NAME}
            fi
            
            helm repo remove ${SRC_REPO_NAME}
        fi
        '''
    }
}


        stage('Helm Lint Check') {
            container('aws') {
                sh '''
                helm lint ${SRC_CHART_NAME}/${SRC_CHART_NAME} || { echo "Helm lint failed!"; exit 1; }
                '''
            }
        }

        stage('Push Helm Chart to Bitbucket (HTTPS + Your Credentials)') {
            withCredentials([usernamePassword(credentialsId: 'kiran-creds', usernameVariable: 'BB_USER', passwordVariable: 'BB_TOKEN')]) {
                container('aws') {
                    sh '''
                    git config --global user.name "${BB_USER}"
                    git config --global user.email "${BB_USER}@yourorg.com"
                    git clone https://${BB_USER}:${BB_TOKEN}@bitbucket.org/your-org/${TARGET_BITBUCKET_REPO}.git

                    cd ${TARGET_BITBUCKET_REPO}
                    git checkout -b mirror_${SRC_CHART_NAME}_${SRC_CHART_VERSION:-latest} || git checkout mirror_${SRC_CHART_NAME}_${SRC_CHART_VERSION:-latest}
                    mkdir -p ${SRC_CHART_NAME}
                    cp -R ../${SRC_CHART_NAME}/${SRC_CHART_NAME}/* ${SRC_CHART_NAME}/

                    git add ${SRC_CHART_NAME}/
                    git commit -m "Mirror: ${SRC_CHART_NAME} ${SRC_CHART_VERSION:-latest} from ${SRC_REPO_URL}"
                    git push https://${BB_USER}:${BB_TOKEN}@bitbucket.org/your-org/${TARGET_BITBUCKET_REPO}.git HEAD
                    '''
                }
            }
        }
    }
}




--------------
pipeline {
    agent any

    parameters {
        string(name: 'SRC_REPO_URL', defaultValue: 'https://charts.bitnami.com/bitnami', description: 'Public Helm repository URL')
        string(name: 'SRC_CHART_NAME', defaultValue: 'nginx', description: 'Chart name to mirror')
        string(name: 'SRC_CHART_VERSION', defaultValue: '', description: 'Chart version (leave empty for latest)')
    }

    environment {
        GIT_REPO = 'git@bitbucket.org:your-org/hydra-helm-upstreams.git'
        LOCAL_DIR = 'mirror'
    }

    stages {
        stage('Prepare workspace') {
            steps {
                sh 'rm -rf ${LOCAL_DIR} && mkdir ${LOCAL_DIR}'
            }
        }

        stage('Pull Helm chart from public repo') {
            steps {
                sh '''
                helm repo add upstream ${SRC_REPO_URL}
                if [ -z "${SRC_CHART_VERSION}" ]; then
                  helm pull upstream/${SRC_CHART_NAME} --untar --untardir ${LOCAL_DIR}
                else
                  helm pull upstream/${SRC_CHART_NAME} --version ${SRC_CHART_VERSION} --untar --untardir ${LOCAL_DIR}
                fi
                helm repo remove upstream
                '''
            }
        }

        stage('Push to hydra-helm-upstreams repo') {
            steps {
                dir("${LOCAL_DIR}") {
                    sh '''
                    git init
                    git remote add origin ${GIT_REPO}
                    git checkout -b main || git checkout main
                    mkdir -p ${SRC_CHART_NAME}
                    mv ${SRC_CHART_NAME}/* ${SRC_CHART_NAME}/
                    git add ${SRC_CHART_NAME}/
                    git config user.name "ci-bot"
                    git config user.email "ci-bot@yourorg.com"
                    git commit -m "Mirrored ${SRC_CHART_NAME} chart from ${SRC_REPO_URL} ${SRC_CHART_VERSION}"
                    git push origin main
                    '''
                }
            }
        }
    }

    post {
        always {
            cleanWs()
        }
    }
}
