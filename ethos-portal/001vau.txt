#!/usr/bin/env bash
set -euo pipefail

REGION="us-east-1"
TABLE_NAME="uat-ade-ethos-588633075404-main-table"
PK_VALUE="ethos|configurations|vault"

put_item () {
  local SORT_KEY="$1"
  local DATA_VALUE="$2"

  aws dynamodb put-item \
    --region "$REGION" \
    --table-name "$TABLE_NAME" \
    --item "{
      \"partitionKey\": {\"S\": \"$PK_VALUE\"},
      \"sortKey\": {\"S\": \"$SORT_KEY\"},
      \"data\": {\"S\": \"$DATA_VALUE\"}
    }" \
    --condition-expression "attribute_not_exists(partitionKey) AND attribute_not_exists(sortKey)"

  echo "Inserted: $SORT_KEY"
}

echo "üîê Verifying AWS identity"
aws sts get-caller-identity

echo "üöÄ Inserting Vault configuration entries"

put_item "vault_base_url" "https://hcvdev.fiscloudservices.com"
put_item "vault_namespace" "CaaS-Parent/A10002786-Ethos_Portal"
put_item "vault_secret_engine" "uat-ethos-portal-backend/"
put_item "vault_enabled" "true"

echo "üìñ Reading back records for partitionKey = $PK_VALUE"

aws dynamodb query \
  --region "$REGION" \
  --table-name "$TABLE_NAME" \
  --key-condition-expression "partitionKey = :pk" \
  --expression-attribute-values "{
    \":pk\": {\"S\": \"$PK_VALUE\"}
  }" \
  --projection-expression "partitionKey, sortKey, data" \
  --output table

echo "‚úÖ Verification complete"








-----------------------------------------------
{{- if .Values.secrets.envFromSecrets }}
envFrom:
{{- range .Values.secrets.envFromSecrets }}
  {{- if . }}
  - secretRef:
      name: {{ . | quote }}
  {{- end }}
{{- end }}
{{- end }}


--

secrets:
  envFromSecrets:
    - vault-token




----------------
#!/bin/bash
set -euo pipefail

echo "Ensuring Vault token Kubernetes secret exists..."

# Retrieve Vault token from Harness secret (backed by Vault)
VAULT_TOKEN="<+secrets.getValue('vault-token-uat-ethos-portal')>"

# Target namespace (from Harness infra)
NAMESPACE="<+infra.namespace>"

SECRET_NAME="vault-token"

# Apply or update the Kubernetes secret
cat <<EOF | kubectl apply -f -
apiVersion: v1
kind: Secret
metadata:
  name: ${SECRET_NAME}
  namespace: ${NAMESPACE}
type: Opaque
stringData:
  token: "${VAULT_TOKEN}"
EOF

echo "Vault token secret '${SECRET_NAME}' ensured in namespace '${NAMESPACE}'."


--

env:
  - name: VAULT_TOKEN
    valueFrom:
      secretKeyRef:
        name: vault-token
        key: token








-----------------------------
vault status
vault token lookup
vault secrets list | head

Create eks-java-read.hcl:
# Allow reading secret values (KV v2)
path "uat-ethos-portal-backend/data/*" {
  capabilities = ["read"]
}

# Allow listing and reading metadata (KV v2)
path "uat-ethos-portal-backend/metadata/*" {
  capabilities = ["list", "read"]
}


vault policy write eks-java-read eks-java-read.hcl

vault token create \
  -display-name="eks-java-uat-ethos-portal" \
  -policy="eks-java-read" \
  -ttl="8760h" \
  -orphan



# Check global caps
vault read sys/config/state/sanitized | egrep -i "default_lease_ttl|max_lease_ttl"

# Check token auth tune
vault read sys/auth/token/tune

