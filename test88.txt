

#!/bin/bash

# Variables
OWNER="602401143452"  # AWS account ID that owns the AMI
NAME_PATTERN="amazon-eks-node-1.27-*"
ROOT_DEVICE_TYPE="ebs"
VIRTUALIZATION_TYPE="hvm"

# Fetch the most recent AMI ID based on the filters
AMI_ID=$(aws ec2 describe-images --owners $OWNER \
         --filters "Name=name,Values=$NAME_PATTERN" \
                   "Name=root-device-type,Values=$ROOT_DEVICE_TYPE" \
                   "Name=virtualization-type,Values=$VIRTUALIZATION_TYPE" \
         --query 'Images | sort_by(@, &CreationDate) | [-1].ImageId' \
         --output text)

echo "Most recent AMI ID: $AMI_ID"


---
.PHONY: all get-ami packer-build

all: get-ami packer-build

get-ami:
    @echo "Fetching latest AMI ID..."
    $(eval EXPORTED_AMI_ID := $(shell bash fetch_ami.sh))

packer-build: 
    @echo "Running Packer with AMI ID $(EXPORTED_AMI_ID)"
    packer build -var 'ami_id=$(EXPORTED_AMI_ID)' packer_template.json

---
#!/bin/bash

# Variables
REGION="us-east-1"
AMI_ID="ami-0123456789abcdef0"  # Replace with your newly created AMI ID
INSTANCE_TYPE="t3.micro"
KEY_NAME="your-key-pair"  # Ensure you have this key pair created in your AWS account
SUBNET_ID="subnet-12345678"  # Replace with your subnet ID
KMS_KEY_ID="alias/aws/ebs"  # The KMS key ID used for encryption

# Launch EC2 instance with specific EBS volume type gp3
INSTANCE_ID=$(aws ec2 run-instances \
  --image-id $AMI_ID \
  --count 1 \
  --instance-type $INSTANCE_TYPE \
  --key-name $KEY_NAME \
  --subnet-id $SUBNET_ID \
  --block-device-mappings "DeviceName=/dev/sda1,Ebs={VolumeType=gp3,VolumeSize=20,Encrypted=True,KmsKeyId=$KMS_KEY_ID,DeleteOnTermination=true}" \
  --query 'Instances[0].InstanceId' \
  --output text \
  --region $REGION)

echo "Launched EC2 instance with ID: $INSTANCE_ID"



----
#!/bin/bash

# Variables
REGION="us-east-1"
AMI_ID="ami-0123456789abcdef0"  # Replace with your new AMI ID
INSTANCE_TYPE="t3.micro"
KEY_NAME="your-key-pair"  # Ensure you have this key pair created in your AWS account
SUBNET_ID="subnet-12345678"  # Replace with your subnet ID

# Launch EC2 instance
INSTANCE_ID=$(aws ec2 run-instances --image-id $AMI_ID --count 1 --instance-type $INSTANCE_TYPE --key-name $KEY_NAME --subnet-id $SUBNET_ID --block-device-mappings DeviceName=/dev/sda1,Ebs={VolumeType=gp3,Encrypted=True} --query 'Instances[0].InstanceId' --output text --region $REGION)

echo "Launched EC2 instance with ID: $INSTANCE_ID"



----
#!/bin/bash

# Variables
REGION="us-east-1"
SOURCE_AMI_ID="ami-0abcdef1234567890"  # Replace with your source AMI ID
KMS_KEY_ID="alias/aws/ebs"  # Your KMS key for encryption
NEW_AMI_NAME="Encrypted-gp3-ami"

# Copy AMI with encryption
NEW_AMI_ID=$(aws ec2 copy-image --region $REGION --source-region $REGION --source-image-id $SOURCE_AMI_ID --name $NEW_AMI_NAME --encrypted --kms-key-id $KMS_KEY_ID --query 'ImageId' --output text)

echo "New AMI ID: $NEW_AMI_ID"
