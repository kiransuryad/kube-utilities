pipeline {
    agent any

    environment {
        // Define environment variables for the public and private repositories
        PUBLIC_IMAGE = "nginx:latest"
        PRIVATE_REPO = "my-private-repo.com/my-nginx"
        PRIVATE_IMAGE = "${PRIVATE_REPO}:latest"
    }

    stages {
        stage('Pull Public Image') {
            steps {
                script {
                    // Pull the public Docker image using Buildah
                    sh "buildah pull docker.io/${PUBLIC_IMAGE}"
                }
            }
        }

        stage('Tag Image for Private Repo') {
            steps {
                script {
                    // Tag the image for the private repository using Buildah
                    sh "buildah tag docker.io/${PUBLIC_IMAGE} ${PRIVATE_IMAGE}"
                }
            }
        }

        stage('Login to Private Repo') {
            steps {
                script {
                    // Log in to the private Docker repository using Buildah
                    withCredentials([usernamePassword(credentialsId: 'docker-creds', usernameVariable: 'DOCKER_USER', passwordVariable: 'DOCKER_PASS')]) {
                        sh "buildah login -u ${DOCKER_USER} -p ${DOCKER_PASS} ${PRIVATE_REPO}"
                    }
                }
            }
        }

        stage('Push to Private Repo') {
            steps {
                script {
                    // Push the tagged image to the private repository using Buildah
                    sh "buildah push ${PRIVATE_IMAGE}"
                }
            }
        }
    }

    post {
        success {
            echo "Docker image successfully cloned and pushed to the private repository using Buildah!"
        }
        failure {
            echo "Failed to clone and push the Docker image using Buildah."
        }
    }
}
